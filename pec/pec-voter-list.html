<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEC Voter Filtering Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    <header>
        <h1>PEC Voter List  <span id="version">v0.13</span></h1>
    </header>
    <main>
        <section>
            <h2>Upload and Filter CSV</h2>
            <input type="file" id="csvFileInput" accept=".csv">
            <div style="margin-top: 10px;">
                <input type="number" id="numRowsInput" placeholder="Number of rows" style="width: 150px; margin-right: 10px;">
                <button id="generateTestData">Generate Test Data</button>
            </div>
            <button id="downloadFilteredCsv">Download Filtered CSV</button>
        </section>
        <section>
            <h3>Filtered Data Preview</h3>
            <table id="dataPreview" border="1">
                <thead></thead>
                <tbody></tbody>
            </table>
        </section>
        <section id="debugLogs">
            <h3>Debug Logs</h3>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 PEC Voter List. All rights reserved.</p>
    </footer>

    <script>
        const csvFileInput = document.getElementById('csvFileInput');
        const generateTestDataButton = document.getElementById('generateTestData');
        const downloadFilteredCsv = document.getElementById('downloadFilteredCsv');
        const dataPreview = document.getElementById('dataPreview');

        let filteredData = [];

        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                logMessage(`File selected: ${file.name}`); // Display file name on the page
                const reader = new FileReader();
                reader.onload = (e) => {
                    const csvData = e.target.result;
                    parseAndFilterData(csvData); // Use the shared parsing logic
                };
                reader.readAsText(file);
            } else {
                logMessage("No file selected.");
            }
        });

        // Event listener for the Generate Test Data button
        generateTestDataButton.addEventListener('click', () => {
            const numRowsInput = document.getElementById('numRowsInput');
            const numRows = parseInt(numRowsInput.value, 10) || 200; // Default to 200 if input is empty or invalid
            logMessage(`Generating ${numRows} rows of test data...`);
            generateTestData(numRows);
        });

        // Placeholder function for generating test data
        function generateTestData(numRows) {
            logMessage(`Generating ${numRows} rows of test data...`);

            // Header row
            const header = [
                "Family Name", "Address 1", "Address 2", "City, Province", "Postal", "Phone 1", "Phone 2", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env.",
                "Contact Type", "Name", "Birth Date", "Age", "Religion", "Phones", "Env."
            ];

            // Generate random data rows
            const dataRows = [];
            for (let i = 0; i < numRows; i++) {
                const familyName = `Family ${i + 1}`;
                const address1 = `${Math.floor(Math.random() * 10000)} Random Street`;
                const address2 = Math.random() > 0.5 ? "Apt " + Math.floor(Math.random() * 100) : "";
                const cityProvince = `City ${i % 50}, Province ${String.fromCharCode(65 + (i % 26))}`;
                const postal = `P${Math.floor(Math.random() * 10)}C ${Math.floor(Math.random() * 10)}${Math.floor(Math.random() * 10)}`;
                const phone1 = Math.random() > 0.5 ? `(H) 555-${Math.floor(1000 + Math.random() * 9000)}` : "";
                const phone2 = Math.random() > 0.5 ? `(C) 555-${Math.floor(1000 + Math.random() * 9000)}` : "";
                const env = `${Math.floor(Math.random() * 20)} Years`;

                // Generate personal records (0 to many)
                const numMembers = Math.floor(Math.random() * 5); // 0 to 4 members
                const personalRecords = [];
                for (let j = 0; j < numMembers; j++) {
                    const contactType = ["Primary", "Secondary", "Other"][Math.floor(Math.random() * 3)];
                    const name = `Member ${j + 1} of Family ${i + 1}`;
                    const birthDate = `${1970 + Math.floor(Math.random() * 50)}-${String(Math.floor(1 + Math.random() * 12)).padStart(2, "0")}-${String(Math.floor(1 + Math.random() * 28)).padStart(2, "0")}`;
                    const age = Math.floor(Math.random() * 100);
                    const religion = ["Roman Catholic", "Protestant", "None", "Other"][Math.floor(Math.random() * 4)];
                    const phones = Math.random() > 0.5 ? `(C) 555-${Math.floor(1000 + Math.random() * 9000)}` : "";
                    const memberEnv = `${Math.floor(Math.random() * 10)} Years`;

                    personalRecords.push(contactType, name, birthDate, age, religion, phones, memberEnv);
                }

                // Fill remaining personal record columns with empty values
                while (personalRecords.length < 63) {
                    personalRecords.push("");
                }

                // Combine family-level data and personal records
                const row = [
                    familyName, address1, address2, cityProvince, postal, phone1, phone2, env,
                    ...personalRecords
                ];
                dataRows.push(row);
            }

            // Combine header and data rows
            const testData = [header, ...dataRows];

            // Convert test data to CSV format
            const csvData = Papa.unparse(testData);

            // Log the raw test data in CSV format
            logMessage(`Raw Test Data (CSV):\n${csvData}`);

            // Use the shared parsing logic
            parseAndFilterData(csvData);
        }

        // Function to display debugging messages on the page
        function logMessage(message) {
            const logSection = document.getElementById('debugLogs');
            const logMessage = document.createElement('p');
            logMessage.textContent = message;
            logSection.appendChild(logMessage);
        }

        function displayData(data) {
            const thead = dataPreview.querySelector('thead');
            const tbody = dataPreview.querySelector('tbody');

            // Clear existing table content
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (data.length > 0) {
                // Create table headers
                const headers = Object.keys(data[0]);
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                // Create table rows
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = row[header];
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            } else {
                console.warn("No data to display."); // Debugging: Log if no data is available
                alert("No data to display.");
            }
        }

        downloadFilteredCsv.addEventListener('click', () => {
            if (filteredData.length > 0) {
                const csvContent = Papa.unparse(filteredData);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'filtered_data.csv');
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('No filtered data available to download.');
            }
        });

        function parseAndFilterData(csvData) {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    const rawData = results.data;

                    // Extract the header row
                    const header = Object.keys(rawData[0]);
                    logMessage(`Header: ${JSON.stringify(header)}`);

                    // Process the data rows
                    filteredData = rawData.flatMap(row => {
                        const familyData = {};
                        const members = [];

                        // Extract family-level data (before the first "Contact Type")
                        for (let i = 0; i < header.length; i++) {
                            if (header[i] === "Contact Type") break;
                            familyData[header[i]] = row[header[i]];
                        }

                        // Extract personal records for each family member
                        let groupStartIndex = header.indexOf("Contact Type");
                        while (groupStartIndex !== -1 && groupStartIndex < header.length) {
                            const contactType = row[header[groupStartIndex]];
                            const name = row[header[groupStartIndex + 1]];
                            const birthDate = row[header[groupStartIndex + 2]];
                            const age = row[header[groupStartIndex + 3]];
                            const religion = row[header[groupStartIndex + 4]];
                            const phones = row[header[groupStartIndex + 5]];
                            const memberEnv = row[header[groupStartIndex + 6]];

                            if (name) { // Only include members with a name
                                members.push({
                                    ...familyData, // Include family-level data
                                    ContactType: contactType,
                                    Name: name,
                                    BirthDate: birthDate,
                                    Age: age,
                                    Religion: religion,
                                    Phones: phones,
                                    MemberEnv: memberEnv
                                });
                            }

                            // Move to the next group of repeating columns
                            groupStartIndex = header.indexOf("Contact Type", groupStartIndex + 7);
                        }

                        return members;
                    });

                    logMessage(`Filtered Data: ${JSON.stringify(filteredData)}`);
                    displayData(filteredData);
                },
                error: (error) => {
                    logMessage(`Error parsing CSV: ${error.message}`);
                }
            });
        }
    </script>
</body>
</html>